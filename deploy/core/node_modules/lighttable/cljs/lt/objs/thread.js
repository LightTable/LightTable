// Compiled by ClojureScript 1.10.844 {}
goog.provide('lt.objs.thread');
goog.require('cljs.core');
goog.require('lt.object');
goog.require('lt.objs.files');
goog.require('lt.objs.platform');
goog.require('lt.objs.console');
goog.require('cljs.reader');
lt.objs.thread.cp = require("child_process");
/**
 * 
 */
lt.objs.thread.__BEH__try_send = (function lt$objs$thread$__BEH__try_send(this$,msg){
if(cljs.core.not.call(null,new cljs.core.Keyword(null,"connected","connected",-169833045).cljs$core$IFn$_invoke$arity$1(cljs.core.deref.call(null,this$)))){
return lt.object.raise.call(null,this$,new cljs.core.Keyword(null,"queue!","queue!",-1061064868),msg);
} else {
return lt.object.raise.call(null,this$,new cljs.core.Keyword(null,"send!","send!",480076706),msg);
}
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","try-send","lt.objs.thread/try-send",97149939),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"try-send!","try-send!",-242671068),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__try_send);
/**
 * 
 */
lt.objs.thread.__BEH__queue_BANG_ = (function lt$objs$thread$__BEH__queue_BANG_(this$,msg){
return lt.object.update_BANG_.call(null,this$,new cljs.core.PersistentVector(null, 1, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.Keyword(null,"queue","queue",1455835879)], null),cljs.core.conj,msg);
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","queue!","lt.objs.thread/queue!",-1364847390),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"queue!","queue!",-1061064868),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__queue_BANG_);
/**
 * 
 */
lt.objs.thread.__BEH__send_BANG_ = (function lt$objs$thread$__BEH__send_BANG_(this$,msg){
return new cljs.core.Keyword(null,"worker","worker",938239996).cljs$core$IFn$_invoke$arity$1(cljs.core.deref.call(null,this$)).send(cljs.core.clj__GT_js.call(null,msg));
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","send!","lt.objs.thread/send!",-876836912),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"send!","send!",480076706),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__send_BANG_);
/**
 * 
 */
lt.objs.thread.__BEH__connect = (function lt$objs$thread$__BEH__connect(this$){
var seq__9008_9012 = cljs.core.seq.call(null,new cljs.core.Keyword(null,"queue","queue",1455835879).cljs$core$IFn$_invoke$arity$1(cljs.core.deref.call(null,this$)));
var chunk__9009_9013 = null;
var count__9010_9014 = (0);
var i__9011_9015 = (0);
while(true){
if((i__9011_9015 < count__9010_9014)){
var q_9016 = cljs.core._nth.call(null,chunk__9009_9013,i__9011_9015);
lt.object.raise.call(null,this$,new cljs.core.Keyword(null,"send!","send!",480076706),q_9016);


var G__9017 = seq__9008_9012;
var G__9018 = chunk__9009_9013;
var G__9019 = count__9010_9014;
var G__9020 = (i__9011_9015 + (1));
seq__9008_9012 = G__9017;
chunk__9009_9013 = G__9018;
count__9010_9014 = G__9019;
i__9011_9015 = G__9020;
continue;
} else {
var temp__5753__auto___9021 = cljs.core.seq.call(null,seq__9008_9012);
if(temp__5753__auto___9021){
var seq__9008_9022__$1 = temp__5753__auto___9021;
if(cljs.core.chunked_seq_QMARK_.call(null,seq__9008_9022__$1)){
var c__4591__auto___9023 = cljs.core.chunk_first.call(null,seq__9008_9022__$1);
var G__9024 = cljs.core.chunk_rest.call(null,seq__9008_9022__$1);
var G__9025 = c__4591__auto___9023;
var G__9026 = cljs.core.count.call(null,c__4591__auto___9023);
var G__9027 = (0);
seq__9008_9012 = G__9024;
chunk__9009_9013 = G__9025;
count__9010_9014 = G__9026;
i__9011_9015 = G__9027;
continue;
} else {
var q_9028 = cljs.core.first.call(null,seq__9008_9022__$1);
lt.object.raise.call(null,this$,new cljs.core.Keyword(null,"send!","send!",480076706),q_9028);


var G__9029 = cljs.core.next.call(null,seq__9008_9022__$1);
var G__9030 = null;
var G__9031 = (0);
var G__9032 = (0);
seq__9008_9012 = G__9029;
chunk__9009_9013 = G__9030;
count__9010_9014 = G__9031;
i__9011_9015 = G__9032;
continue;
}
} else {
}
}
break;
}

return lt.object.merge_BANG_.call(null,this$,new cljs.core.PersistentArrayMap(null, 2, [new cljs.core.Keyword(null,"connected","connected",-169833045),true,new cljs.core.Keyword(null,"queue","queue",1455835879),cljs.core.PersistentVector.EMPTY], null));
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","connect","lt.objs.thread/connect",396017879),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"connect","connect",1232828233),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__connect);
/**
 * 
 */
lt.objs.thread.__BEH__message = (function lt$objs$thread$__BEH__message(this$,m){
var temp__5753__auto__ = lt.object.by_id.call(null,m.obj);
if(cljs.core.truth_(temp__5753__auto__)){
var obj = temp__5753__auto__;
return lt.object.raise.call(null,obj,(((!((m.msg instanceof cljs.core.Keyword))))?cljs.core.keyword.call(null,m.msg):m.msg),((cljs.core._EQ_.call(null,"clj",m.format))?cljs.reader.read_string.call(null,m.res):m.res));
} else {
return null;
}
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","message","lt.objs.thread/message",438532424),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"message","message",-406056002),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__message);
/**
 * 
 */
lt.objs.thread.__BEH__kill_BANG_ = (function lt$objs$thread$__BEH__kill_BANG_(this$){
return new cljs.core.Keyword(null,"worker","worker",938239996).cljs$core$IFn$_invoke$arity$1(cljs.core.deref.call(null,this$)).kill();
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","kill!","lt.objs.thread/kill!",559786964),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"kill!","kill!",1274963514),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__kill_BANG_);
/**
 * 
 */
lt.objs.thread.__BEH__shutdown_worker_on_close = (function lt$objs$thread$__BEH__shutdown_worker_on_close(app){
return lt.object.raise.call(null,lt.objs.thread.worker,new cljs.core.Keyword(null,"kill!","kill!",1274963514));
});

lt.object.behavior_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","shutdown-worker-on-close","lt.objs.thread/shutdown-worker-on-close",87823339),new cljs.core.Keyword(null,"triggers","triggers",-1443678770),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"closed","closed",-919675359),null], null), null),new cljs.core.Keyword(null,"reaction","reaction",490869788),lt.objs.thread.__BEH__shutdown_worker_on_close);
lt.object.object_STAR_.call(null,new cljs.core.Keyword("lt.objs.thread","worker-thread","lt.objs.thread/worker-thread",288267440),new cljs.core.Keyword(null,"tags","tags",1771418977),new cljs.core.PersistentHashSet(null, new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"worker-thread","worker-thread",-552877514),null], null), null),new cljs.core.Keyword(null,"queue","queue",1455835879),cljs.core.PersistentVector.EMPTY,new cljs.core.Keyword(null,"init","init",-1875481434),(function (this$){
var worker = lt.objs.thread.cp.fork(lt.objs.files.lt_home.call(null,"/core/node_modules/lighttable/background/threadworker.js"),cljs.core.clj__GT_js.call(null,new cljs.core.PersistentVector(null, 1, 5, cljs.core.PersistentVector.EMPTY_NODE, ["--harmony"], null)),cljs.core.clj__GT_js.call(null,new cljs.core.PersistentArrayMap(null, 4, [new cljs.core.Keyword(null,"execPath","execPath",2029107592),process.execPath,new cljs.core.Keyword(null,"silent","silent",-1142977785),true,new cljs.core.Keyword(null,"env","env",-1815813235),new cljs.core.PersistentArrayMap(null, 1, ["ATOM_SHELL_INTERNAL_RUN_AS_NODE",(1)], null),new cljs.core.Keyword(null,"cwd","cwd",14056523),lt.objs.files.cwd], null)));
worker.stdout.on("data",(function (data){
return lt.objs.console.loc_log.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"file","file",-1269645878),"thread",new cljs.core.Keyword(null,"line","line",212345235),"stdout",new cljs.core.Keyword(null,"content","content",15833224),cljs.core.str.cljs$core$IFn$_invoke$arity$1(data)], null));
}));

worker.stderr.on("data",(function (data){
return lt.objs.console.loc_log.call(null,new cljs.core.PersistentArrayMap(null, 4, [new cljs.core.Keyword(null,"file","file",-1269645878),"thread",new cljs.core.Keyword(null,"line","line",212345235),"stderr",new cljs.core.Keyword(null,"content","content",15833224),cljs.core.str.cljs$core$IFn$_invoke$arity$1(data),new cljs.core.Keyword(null,"class","class",-2030961996),"error"], null));
}));

worker.on("message",(function (m){
return lt.object.raise.call(null,this$,new cljs.core.Keyword(null,"message","message",-406056002),m);
}));

worker.send(cljs.core.clj__GT_js.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"msg","msg",-1386103444),"init",new cljs.core.Keyword(null,"obj","obj",981763962),lt.object.__GT_id.call(null,this$),new cljs.core.Keyword(null,"ltpath","ltpath",-133203470),lt.objs.files.lt_home.call(null)], null)));

lt.object.merge_BANG_.call(null,this$,new cljs.core.PersistentArrayMap(null, 1, [new cljs.core.Keyword(null,"worker","worker",938239996),worker], null));

return null;
}));
lt.objs.thread.send = (function lt$objs$thread$send(msg){
return lt.object.raise.call(null,lt.objs.thread.worker,new cljs.core.Keyword(null,"try-send!","try-send!",-242671068),msg);
});
lt.objs.thread.thread_STAR_ = (function lt$objs$thread$thread_STAR_(func){
var func_str = ["",cljs.core.str.cljs$core$IFn$_invoke$arity$1(func)].join('');
var n = cljs.core.gensym.call(null,"threadfunc");
lt.objs.thread.send.call(null,new cljs.core.PersistentArrayMap(null, 3, [new cljs.core.Keyword(null,"msg","msg",-1386103444),"register",new cljs.core.Keyword(null,"name","name",1843675177),n,new cljs.core.Keyword(null,"func","func",-238706040),func_str], null));

return (function() { 
var G__9033__delegate = function (obj,args){
return lt.objs.thread.send.call(null,new cljs.core.PersistentArrayMap(null, 4, [new cljs.core.Keyword(null,"msg","msg",-1386103444),"call",new cljs.core.Keyword(null,"name","name",1843675177),n,new cljs.core.Keyword(null,"obj","obj",981763962),lt.object.__GT_id.call(null,obj),new cljs.core.Keyword(null,"params","params",710516235),cljs.core.map.call(null,cljs.core.pr_str,args)], null));
};
var G__9033 = function (obj,var_args){
var args = null;
if (arguments.length > 1) {
var G__9034__i = 0, G__9034__a = new Array(arguments.length -  1);
while (G__9034__i < G__9034__a.length) {G__9034__a[G__9034__i] = arguments[G__9034__i + 1]; ++G__9034__i;}
  args = new cljs.core.IndexedSeq(G__9034__a,0,null);
} 
return G__9033__delegate.call(this,obj,args);};
G__9033.cljs$lang$maxFixedArity = 1;
G__9033.cljs$lang$applyTo = (function (arglist__9035){
var obj = cljs.core.first(arglist__9035);
var args = cljs.core.rest(arglist__9035);
return G__9033__delegate(obj,args);
});
G__9033.cljs$core$IFn$_invoke$arity$variadic = G__9033__delegate;
return G__9033;
})()
;
});
lt.object.tag_behaviors.call(null,new cljs.core.Keyword(null,"worker-thread","worker-thread",-552877514),new cljs.core.PersistentVector(null, 6, 5, cljs.core.PersistentVector.EMPTY_NODE, [new cljs.core.Keyword("lt.objs.thread","kill!","lt.objs.thread/kill!",559786964),new cljs.core.Keyword("lt.objs.thread","connect","lt.objs.thread/connect",396017879),new cljs.core.Keyword("lt.objs.thread","send!","lt.objs.thread/send!",-876836912),new cljs.core.Keyword("lt.objs.thread","queue!","lt.objs.thread/queue!",-1364847390),new cljs.core.Keyword("lt.objs.thread","try-send","lt.objs.thread/try-send",97149939),new cljs.core.Keyword("lt.objs.thread","message","lt.objs.thread/message",438532424)], null));
lt.objs.thread.worker = lt.object.create.call(null,new cljs.core.Keyword("lt.objs.thread","worker-thread","lt.objs.thread/worker-thread",288267440));
